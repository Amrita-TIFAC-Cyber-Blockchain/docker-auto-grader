name: Docker Auto-Grader

on:
  workflow_dispatch:     # Manual trigger from GitHub Actions UI
  push:
    branches: [ main ]   # Optional automatic trigger

jobs:
  grade:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Prevent long-running jobs

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Create logs directory
      - name: Setup log directories
        run: |
          mkdir -p logs
          echo "image,result" > results.csv

      # Step 3: Read and process student images
      - name: Run grading for each student image
        run: |
          echo "Starting automated Docker grading..."
          while read -r image; do
            echo "============================="
            echo "Testing image: $image"
            echo "============================="

            # Clean previous container (if any)
            docker rm -f test_container >/dev/null 2>&1 || true

            log_file="logs/${image//\//_}.log"
            echo "Log file: $log_file" > "$log_file"

            # Step 3.1: Pull image from Docker Hub
            if docker pull "$image" >> "$log_file" 2>&1; then
              echo "âœ… Image pulled successfully" | tee -a "$log_file"
            else
              echo "âŒ FAILED: Unable to pull $image" | tee -a "$log_file"
              echo "$image,FAIL (pull error)" >> results.csv
              continue
            fi

            # Step 3.2: Run container in detached mode
            echo "â–¶ï¸ Starting container..." | tee -a "$log_file"
            container_id=$(docker run -d -p 8080:8080 --name test_container "$image" 2>>"$log_file" || echo "fail")

            if [ "$container_id" = "fail" ] || [ -z "$container_id" ]; then
              echo "âŒ Container failed to start" | tee -a "$log_file"
              echo "$image,FAIL (start error)" >> results.csv
              continue
            fi

            # Step 3.3: Wait a bit for service startup
            echo "â³ Waiting for app to start..." | tee -a "$log_file"
            sleep 10

            # Step 3.4: Run the test script
            echo "ðŸ§ª Running test script..." | tee -a "$log_file"
            if python3 tests/test_script.py >>"$log_file" 2>&1; then
              echo "âœ… PASS - $image" | tee -a "$log_file"
              echo "$image,PASS" >> results.csv
            else
              echo "âŒ FAIL - $image" | tee -a "$log_file"
              echo "$image,FAIL (test failed)" >> results.csv
            fi

            # Step 3.5: Stop and clean up container
            echo "ðŸ§¹ Cleaning up..." | tee -a "$log_file"
            docker rm -f test_container >/dev/null 2>&1 || true
            echo "" >> "$log_file"

          done < students.txt

      # Step 4: Upload results and logs
      - name: Upload grading results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grading-results
          path: |
            logs/
            results.csv
