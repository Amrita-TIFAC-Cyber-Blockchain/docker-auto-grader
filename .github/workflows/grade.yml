name: Docker Auto-Grader

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  grade:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create logs directory
        run: mkdir -p logs

      - name: Read student list and run IPFS tests
        run: |
          echo "============================="
          echo "Starting Docker Auto-Grader for IPFS Images"
          echo "============================="

          pip install requests >/dev/null 2>&1

          while read -r image; do
            echo "--------------------------------------"
            echo "Testing image: $image"
            echo "--------------------------------------"
            log_file="logs/${image//\//_}.log"

            # Pull the image
            if docker pull $image >> "$log_file" 2>&1; then
              echo "âœ… Image pulled successfully" >> "$log_file"
            else
              echo "âŒ FAILED: Unable to pull $image" >> "$log_file"
              echo "$image,FAIL" >> results.csv
              continue
            fi

            # Run container exposing IPFS API
            docker run -d --name test_container -p 4001:4001 -p 5001:5001 -p 8080:8080 $image >> "$log_file" 2>&1
            sleep 10

            # Run the IPFS test script on the runner (connecting to container)
            echo "ðŸ” Running IPFS test script on runner..." >> "$log_file"
            python3 tests/test_script.py >> "$log_file" 2>&1
            result=$?

            # Cleanup container
            docker stop test_container >> "$log_file" 2>&1
            docker rm test_container >> "$log_file" 2>&1

            # Record result
            if [ $result -eq 0 ]; then
              echo "âœ… PASS - $image" | tee -a "$log_file"
              echo "$image,PASS" >> results.csv
            else
              echo "âŒ FAIL - $image" | tee -a "$log_file"
              echo "$image,FAIL" >> results.csv
            fi
            echo "" >> "$log_file"
          done < students.txt

      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: grading-results
          path: |
            logs/
            results.csv
